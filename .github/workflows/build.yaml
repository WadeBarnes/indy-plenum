name: indy-plenum-build
on: [ push, pull_request ]

jobs:
<<<<<<< HEAD

  indy_plenum_tests:
    name: Indy Plenum Test Slices
    runs-on: ubuntu-18.04
    #TODO: move this to hyperledger?
    container: wwjbarnes/indy-plenum-ci:latest
=======
  workflow-setup:
    runs-on: ubuntu-latest
    outputs:
      CACHE_KEY_IMAGE: ${{ steps.cache.outputs.CACHE_KEY_IMAGE }}
    steps:
      - name: Git checkout
        uses: actions/checkout@v2
      - name: Set outputs
        id: cache
        run: |
          echo "::set-output name=CACHE_KEY_IMAGE::${{ hashFiles('.github/workflows/Dockerfile') }}"

  build-image:
    needs: workflow-setup
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: 1
      CACHE_KEY_IMAGE: ${{ needs.workflow-setup.outputs.CACHE_KEY_IMAGE }}
    steps:
      - name: Git checkout
        uses: actions/checkout@v2
      - name: Try load from cache.
        id: cache-image
        uses: actions/cache@v2
        with:
          path: ${GITHUB_WORKSPACE}/cache
          key: ${{ env.CACHE_KEY_IMAGE}}
      - name: If NOT found in cache, build and push image.
        if: steps.cache-image.outputs.cache-hit != 'true'
        run: |
          echo ${{ secrets.CR_PAT }} | docker login ghcr.io --username ${{ secrets.CR_USER }} --password-stdin
          docker build -f .github/workflows/Dockerfile --no-cache -t ${GITHUB_REPOSITORY}/plenum-build:${{ env.CACHE_KEY_IMAGE }} .
          docker tag ${GITHUB_REPOSITORY}/plenum-build:${{ env.CACHE_KEY_IMAGE }} ghcr.io/${GITHUB_REPOSITORY}/plenum-build:latest
          docker push ghcr.io/${GITHUB_REPOSITORY}/plenum-build:latest
          mkdir -p ${GITHUB_WORKSPACE}/cache
          touch ${GITHUB_WORKSPACE}/cache/${{ env.CACHE_KEY_IMAGE }}

  indy_plenum_tests:
    name: Indy Plenum Test Slices
    needs: build-image
    runs-on: ubuntu-20.04
    container:
      image: ghcr.io/${{ github.repository }}/plenum-build
>>>>>>> adds build image and caching
    strategy:
      matrix:
        module: [plenum]
        slice: [1, 2, 3]
      fail-fast: false
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Install dependencies
        run: pip install .[tests]

      - name: Run Indy Plenum ${{ matrix.module }} test slice ${{ matrix.slice }}/3
        run: RUSTPYTHONASYNCIODEBUG=0 python runner.py --pytest "python -m pytest -l -vv --junitxml=test-result-plenum-${{ matrix.module }}-${{ matrix.slice }}.xml" --dir "${{ matrix.module }}" --output "test-result-plenum-${{ matrix.slice }}.txt" --test-only-slice "${{ matrix.slice }}/3"

      - name: Publish Test Report
        uses: scacap/action-surefire-report@v1
        with:
          check_name: Indy Plenum ${{ matrix.module }} Test Report for slice ${{ matrix.slice }}/3
          github_token: ${{ secrets.GITHUB_TOKEN }}
          report_paths: test-result-plenum-${{ matrix.module }}-${{ matrix.slice }}.xml

  indy_plenum:
    name: Indy Plenum Tests
<<<<<<< HEAD
    runs-on: ubuntu-18.04
    #TODO: move this to hyperledger?
    container: wwjbarnes/indy-plenum-ci:latest
=======
    needs: build-image
    runs-on: ubuntu-20.04
    container:
      image: ghcr.io/${{ github.repository }}/plenum-build
>>>>>>> adds build image and caching
    strategy:
      matrix:
        module: [common, crypto, ledger, state, storage, stp_core, stp_zmq]
      fail-fast: false
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Install dependencies
        run: pip install .[tests]

      - name: Run Indy Plenum ${{ matrix.module }} tests
        run: python -m pytest -l -vv --junitxml=test-result-plenum-${{ matrix.module }}.xml ${{ matrix.module }}

      - name: Publish Test Report
        uses: scacap/action-surefire-report@v1
        with:
          check_name: Indy Plenum ${{ matrix.module }} Test Report
          github_token: ${{ secrets.GITHUB_TOKEN }}
          report_paths: test-result-plenum-${{ matrix.module }}.xml

  lint:
    name: Lint
    needs: build-image
    runs-on: ubuntu-20.04
    container:
      image: ghcr.io/hyperledger/indy_node/indy-node-lint
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: flake8
        run: python3 -m flake8
